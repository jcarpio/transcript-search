<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Transcripciones</title>
    <link rel="stylesheet" href="https://cdn.muicss.com/mui-0.9.20/css/mui.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.14/vue.min.js"></script>
    <style>
        /* üìå Estilo para la cuadr√≠cula de resultados */
        .results-container {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
        }
        .result-card {
            flex: 1 1 calc(33.333% - 16px); /* 3 columnas en pantallas grandes */
            max-width: 320px;
            min-width: 280px;
            padding: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            transition: transform 0.2s;
        }
        .result-card:hover {
            transform: scale(1.05);
        }
        @media (max-width: 768px) {
            .result-card {
                flex: 1 1 calc(50% - 16px); /* 2 columnas en pantallas medianas */
            }
        }
        @media (max-width: 480px) {
            .result-card {
                flex: 1 1 100%; /* 1 columna en pantallas peque√±as */
            }
        }
    </style>
</head>
<body>
    <div id="app" class="mui-container">
        <h2>üîé Buscador de Transcripciones</h2>

        <div class="mui-panel">
            <div class="mui-textfield">
                <input v-model="searchTerm" type="text" placeholder="Escribe un t√©rmino de b√∫squeda...">
            </div>
            <button class="mui-btn mui-btn--raised mui-btn--primary" v-on:click="search(0)">Buscar</button>
        </div>

        <div v-if="loading" class="mui-panel">
            <p>‚è≥ Buscando resultados...</p>
        </div>

        <div v-if="results.length > 0">
            <h3>Resultados ({{ totalResults }})</h3>
            <div class="results-container">
                <div v-for="hit in results" class="result-card">
                    <strong>{{ hit._source.title }}</strong> - {{ hit._source.author }} <br>
                    üìå <span v-html="hit.highlight.text[0]"></span><br>
                    üé• <a :href="getYouTubeTimestampedURL(hit._source.url_youtube, hit._source.text)" target="_blank">
                        Ver en YouTube ‚è≥ ({{ extractTimestamp(hit._source.text) }})
                    </a>
                </div>
            </div>
        </div>

        <!-- üîÑ Botones de paginaci√≥n -->
        <div v-if="totalResults > resultsPerPage" class="mui-panel">
            <button class="mui-btn" v-on:click="prevPage" :disabled="offset === 0">‚¨Ö Anterior</button>
            <button class="mui-btn" v-on:click="nextPage" :disabled="offset + resultsPerPage >= totalResults">Siguiente ‚û°</button>
        </div>

        <div v-if="results.length === 0 && !loading" class="mui-panel">
            <p>‚ö†Ô∏è No se encontraron resultados.</p>
        </div>
    </div>

    <script>
        new Vue({
            el: "#app",
            data: {
                searchTerm: "",
                results: [],
                totalResults: 0,
                loading: false,
                offset: 0, // üìå Control de paginaci√≥n
                resultsPerPage: 8 // üìå Ahora muestra 9 resultados por p√°gina
            },
            methods: {
                search(offset = 0) {
                    if (!this.searchTerm.trim()) {
                        alert("Por favor ingresa un t√©rmino de b√∫squeda.");
                        return;
                    }

                    this.loading = true;
                    this.results = [];
                    this.offset = offset; // üìå Actualizar la paginaci√≥n

                    axios.get(`/search?term=${encodeURIComponent(this.searchTerm)}&offset=${this.offset}`)
                        .then(response => {
                            this.totalResults = response.data.total.value;
                            this.results = response.data.hits;
                        })
                        .catch(error => {
                            console.error("‚ùå Error en la b√∫squeda:", error);
                            alert("Ocurri√≥ un error al buscar. Intenta nuevamente.");
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                },

                /** ‚èÆ Funci√≥n para retroceder en la paginaci√≥n */
                prevPage() {
                    if (this.offset > 0) {
                        this.search(this.offset - this.resultsPerPage);
                    }
                },

                /** ‚è≠ Funci√≥n para avanzar en la paginaci√≥n */
                nextPage() {
                    if (this.offset + this.resultsPerPage < this.totalResults) {
                        this.search(this.offset + this.resultsPerPage);
                    }
                },

                /** Extraer el timestamp (hh:mm:ss) del texto del p√°rrafo */
                extractTimestamp(text) {
                    const match = text.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?/);
                    if (match) {
                        return match[0]; // Devuelve el timestamp en formato hh:mm:ss o mm:ss
                    }
                    return "0:00"; // Si no encuentra nada, devuelve inicio del video
                },

                /** Convertir hh:mm:ss o mm:ss a segundos */
                convertToSeconds(timestamp) {
                    const parts = timestamp.split(":").map(Number);
                    if (parts.length === 3) {
                        return parts[0] * 3600 + parts[1] * 60 + parts[2]; // hh:mm:ss ‚Üí segundos
                    } else if (parts.length === 2) {
                        return parts[0] * 60 + parts[1]; // mm:ss ‚Üí segundos
                    }
                    return 0;
                },

                /** Generar la URL con el timestamp en YouTube */
                getYouTubeTimestampedURL(url, text) {
                    if (!url) return "#"; // Evita enlaces rotos
                    const timestamp = this.extractTimestamp(text);
                    const seconds = this.convertToSeconds(timestamp);
                    return `${url.split("&")[0]}&t=${seconds}s`; // Agrega el tiempo en segundos
                }
            }
        });
    </script>
</body>
</html>
