<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador</title>
    <link href="https://cdn.muicss.com/mui-0.9.20/css/mui.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .search-container { margin-bottom: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .result-card { padding: 15px; border-radius: 8px; background: #f9f9f9; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1); }
        .bold { font-weight: bold; }
        .pagination { display: flex; justify-content: space-between; margin-top: 20px; }
        @media (max-width: 768px) { .grid-container { grid-template-columns: repeat(1, 1fr); } }
    </style>
</head>
<body>

    <div class="search-container">
        <input type="text" id="searchTerm" placeholder="Escribe aqu√≠..." class="mui-textfield">
        <button onclick="search()" class="mui-btn mui-btn--primary">BUSCAR</button>
    </div>

    <h3 id="resultCount">Resultados (0)</h3>
    <div class="grid-container" id="results"></div>

    <div class="pagination">
        <button onclick="prevPage()" class="mui-btn mui-btn--raised" id="prevBtn" disabled>‚¨Ö ANTERIOR</button>
        <button onclick="nextPage()" class="mui-btn mui-btn--raised" id="nextBtn" disabled>SIGUIENTE ‚û°</button>
    </div>

    <script>
        let searchTerm = "";
        let offset = 0;
        const resultsPerPage = 9;

        async function search() {
            searchTerm = document.getElementById("searchTerm").value.trim();
            if (!searchTerm) return alert("Introduce un t√©rmino de b√∫squeda");

            offset = 0;
            fetchResults();
        }

        async function fetchResults() {
            const response = await fetch(`/search?term=${encodeURIComponent(searchTerm)}&offset=${offset}`);
            const data = await response.json();

            document.getElementById("resultCount").innerText = `Resultados (${data.total.value})`;

            const resultsContainer = document.getElementById("results");
            resultsContainer.innerHTML = "";

            data.hits.slice(0, resultsPerPage).forEach(hit => {
                const { title, author, url_youtube, location, text } = hit._source;
                const highlightedText = hit.highlight?.text[0] || text;

                // Extraer el timestamp en formato 00:00
                const timeMatch = text.match(/^(\d{1,2}:\d{2})/);
                const timestamp = timeMatch ? timeMatch[1] : "0:00";
                const youtubeLink = `${url_youtube}&t=${timestamp.replace(":", "m")}s`;

                // Reemplazar la palabra buscada con <strong>
                const highlightedHTML = highlightedText.replace(new RegExp(searchTerm, "gi"), match => `<strong>${match}</strong>`);

                resultsContainer.innerHTML += `
                    <div class="result-card">
                        <strong>${title}</strong> - ${author} <br>
                        üìå ${timestamp} ${highlightedHTML} <br>
                        üé• <a href="${youtubeLink}" target="_blank">Ver en YouTube ‚è≥ (${timestamp})</a>
                    </div>
                `;
            });

            // Control de botones de paginaci√≥n
            document.getElementById("prevBtn").disabled = offset === 0;
            document.getElementById("nextBtn").disabled = offset + resultsPerPage >= data.total.value;
        }

        function prevPage() {
            if (offset > 0) {
                offset -= resultsPerPage;
                fetchResults();
            }
        }

        function nextPage() {
            offset += resultsPerPage;
            fetchResults();
        }
    </script>

</body>
</html>
